generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model EvaluationCycle {
  id          Int                    @id @default(autoincrement())
  name        String                 @db.VarChar(255)
  startDate   DateTime               @db.DateTime(0)
  endDate     DateTime               @db.DateTime(0)
  status      SystemStatus           @default(DEFINE)
  code        String                 @unique
  createdAt   DateTime               @default(now())
  publicId    String                 @unique @default(uuid())
  updatedAt   DateTime               @updatedAt
  assignments EvaluationAssignment[]
}

model Organization {
  id        String              @id @default(uuid())
  code      String              @unique
  name      String
  parentId  String?
  managerId String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  employees Employee[]
  histories EmploymentHistory[]
  manager   Employee?           @relation("OrgManager", fields: [managerId], references: [id])
  parent    Organization?       @relation("OrgTree", fields: [parentId], references: [id])
  children  Organization[]      @relation("OrgTree")

  @@index([parentId])
  @@index([managerId])
}

model Position {
  id        String              @id @default(uuid())
  code      String              @unique
  name      String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  employees Employee[]
  histories EmploymentHistory[]
}

model Level {
  id        String              @id @default(uuid())
  code      String              @unique
  name      String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  employees Employee[]
  histories EmploymentHistory[]
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique(map: "User_email_key")
  passwordHash String
  isActive     Boolean   @default(true)
  employeeId   String?   @unique(map: "User_employeeId_key")
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  isAdmin      Boolean   @default(false)
  employee     Employee? @relation(fields: [employeeId], references: [id])
  sessions Session[]
  notifications NotificationRecipient[]

  @@map("user")
}

model Employee {
  id                   String                 @id @default(uuid())
  prefixName           PrefixName
  name                 String
  lastName             String
  nickname             String
  employeeNo           String                 @unique
  birthDate            DateTime?              @db.DateTime(0)
  gender               Gender?                @default(UNSPECIFIED)
  email                String                 @unique
  phone                String?
  startDate            DateTime
  terminatedDate       DateTime?
  organizationId       String
  positionId           String
  levelId              String
  jobDescription       String?
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  level                Level                  @relation(fields: [levelId], references: [id])
  organization         Organization           @relation(fields: [organizationId], references: [id])
  position             Position               @relation(fields: [positionId], references: [id])
  histories            EmploymentHistory[]
  evaluateeAssignments EvaluationAssignment[] @relation("Evaluatee")
  evaluatorAssignments EvaluationAssignment[] @relation("Evaluator")
  submittedAssignments EvaluationAssignment[] @relation("AssignmentSubmittedBy")
  requestedKpiPlans    KpiPlan[]              @relation("PlanConfirmRequestedBy")
  confirmedKpiPlans    KpiPlan[]              @relation("PlanConfirmedBy")
  rejectedKpiPlans     KpiPlan[]              @relation("PlanRejectedBy")
  actedNotifications   Notification[]         @relation("NotificationActor")
  managedOrganizations Organization[]         @relation("OrgManager")
  user                 User?

  @@index([organizationId])
  @@index([positionId])
  @@index([levelId])
}

model EmploymentHistory {
  id             String       @id @default(uuid())
  employeeId     String
  positionId     String
  levelId        String
  organizationId String
  startDate      DateTime     @db.DateTime(0)
  endDate        DateTime?    @db.DateTime(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  employee       Employee     @relation(fields: [employeeId], references: [id])
  level          Level        @relation(fields: [levelId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  position       Position     @relation(fields: [positionId], references: [id])

  @@index([employeeId, startDate])
  @@index([employeeId, endDate])
  @@index([organizationId, startDate])
  @@index([levelId], map: "EmploymentHistory_levelId_fkey")
  @@index([positionId], map: "EmploymentHistory_positionId_fkey")
}

model EvaluationAssignment {
  id            String               @id @default(uuid())
  cycleId       Int
  evaluatorId   String
  evaluateeId   String
  weightPercent Decimal              @db.Decimal(5, 2)
  currentPlanId String?              @unique
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  evalStatus    AssignmentEvalStatus @default(NOT_STARTED)
  submittedAt   DateTime?
  submittedById String?
  currentPlan   KpiPlan?             @relation("AssignmentCurrentPlan", fields: [currentPlanId], references: [id])
  cycle         EvaluationCycle      @relation(fields: [cycleId], references: [id])
  evaluatee     Employee             @relation("Evaluatee", fields: [evaluateeId], references: [id])
  evaluator     Employee             @relation("Evaluator", fields: [evaluatorId], references: [id])
  submittedBy   Employee?            @relation("AssignmentSubmittedBy", fields: [submittedById], references: [id])
  plans         KpiPlan[]

  @@unique([cycleId, evaluatorId, evaluateeId])
  @@index([evaluateeId, cycleId])
  @@index([evaluatorId, cycleId])
  @@index([submittedById], map: "EvaluationAssignment_submittedById_fkey")
}

model KpiType {
  id        String         @id @default(uuid())
  type      KpiTypeChoices
  name      String
  rubric    Json
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  nodes     KpiNode[]
}

model KpiPlan {
  id                   String                @id @default(uuid())
  assignmentId         String
  version              Int
  status               PlanStatus            @default(DRAFT)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  confirmRequestedAt   DateTime?
  confirmRequestedById String?
  confirmStatus        PlanConfirmStatus     @default(DRAFT)
  confirmTarget        PlanConfirmTarget?
  confirmedAt          DateTime?
  confirmedById        String?
  rejectReason         String?
  rejectedAt           DateTime?
  rejectedById         String?
  currentOfAssignment  EvaluationAssignment? @relation("AssignmentCurrentPlan")
  nodes                KpiNode[]
  assignment           EvaluationAssignment  @relation(fields: [assignmentId], references: [id])
  confirmRequestedBy   Employee?             @relation("PlanConfirmRequestedBy", fields: [confirmRequestedById], references: [id])
  confirmedBy          Employee?             @relation("PlanConfirmedBy", fields: [confirmedById], references: [id])
  rejectedBy           Employee?             @relation("PlanRejectedBy", fields: [rejectedById], references: [id])

  @@unique([assignmentId, version])
  @@index([assignmentId, status])
  @@index([assignmentId, confirmStatus])
  @@index([confirmStatus, confirmTarget])
  @@index([confirmRequestedById], map: "KpiPlan_confirmRequestedById_fkey")
  @@index([confirmedById], map: "KpiPlan_confirmedById_fkey")
  @@index([rejectedById], map: "KpiPlan_rejectedById_fkey")
}

model KpiNode {
  id                  String          @id @default(uuid())
  planId              String
  nodeType            KpiNodeType
  title               String
  description         String?
  parentId            String?
  weightPercent       Decimal         @db.Decimal(5, 2)
  typeId              String?
  unit                String?
  currentSubmissionId String?         @unique
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  endDate             DateTime?       @db.DateTime(0)
  startDate           DateTime?       @db.DateTime(0)
  sortOrder           Int             @default(0)
  currentSubmission   KpiSubmission?  @relation("NodeCurrentSubmission", fields: [currentSubmissionId], references: [id])
  parent              KpiNode?        @relation("NodeParent", fields: [parentId], references: [id])
  children            KpiNode[]       @relation("NodeParent")
  plan                KpiPlan         @relation(fields: [planId], references: [id])
  type                KpiType?        @relation(fields: [typeId], references: [id])
  submissions         KpiSubmission[] @relation("NodeSubmissions")

  @@index([planId])
  @@index([parentId])
  @@index([planId, parentId, sortOrder])
  @@index([typeId], map: "KpiNode_typeId_fkey")
}

model KpiSubmission {
  id              String   @id @default(uuid())
  nodeId          String
  version         Int
  payload         Json
  calculatedScore Int?
  finalScore      Int?
  note            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  currentOfNode   KpiNode? @relation("NodeCurrentSubmission")
  node            KpiNode  @relation("NodeSubmissions", fields: [nodeId], references: [id])

  @@unique([nodeId, version])
  @@index([nodeId, createdAt])
}

model Notification {
  id         String                  @id @default(uuid())
  type       NotificationType
  actorId    String?
  cycleId    Int?
  createdAt  DateTime                @default(now())
  meta       Json?
  actor      Employee?               @relation("NotificationActor", fields: [actorId], references: [id])
  recipients NotificationRecipient[]

  @@index([type])
  @@index([createdAt])
  @@index([actorId], map: "Notification_actorId_fkey")
}

model NotificationRecipient {
  id             String       @id @default(uuid())
  notificationId String
  userId         String
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id])
  user   User @relation(fields: [userId], references: [id], map: "NotificationRecipient_userId_fkey_v2")

  @@unique([notificationId, userId])
  @@index([userId, readAt])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Session_userId_fkey_v2")

  @@index([userId])
  @@index([expiresAt])
}

enum SystemStatus {
  DEFINE
  EVALUATE
  SUMMARY
}

enum PlanStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum KpiNodeType {
  GROUP
  ITEM
}

enum KpiTypeChoices {
  QUANTITATIVE
  QUALITATIVE
  CUSTOM
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNSPECIFIED
}

enum PrefixName {
  MR
  MRS
  MS
}

enum PlanConfirmStatus {
  DRAFT
  REQUESTED
  CONFIRMED
  REJECTED
  CANCELLED
}

enum PlanConfirmTarget {
  EVALUATOR
  EVALUATEE
}

enum AssignmentEvalStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
}

enum NotificationType {
  EVALUATEE_REQUEST_EVALUATOR_APPROVE_KPI
  EVALUATEE_CONFIRM_EVALUATOR_KPI
  EVALUATEE_REJECT_EVALUATOR_KPI
  EVALUATOR_REQUEST_EVALUATEE_CONFIRM_KPI
  EVALUATOR_REQUEST_EVALUATEE_DEFINE_KPI
  EVALUATOR_APPROVE_EVALUATEE_KPI
  EVALUATOR_REJECT_EVALUATEE_KPI
  EVALUATOR_CANCEL_REQUEST_EVALUATEE_CONFIRM_KPI
}
